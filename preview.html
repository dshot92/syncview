<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync View Preview</title>
    <style>
        html,
        body {
            width: 1200px;
            height: 630px;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #0b0e14;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            color: #e6e9ef;
        }

        .frame {
            width: 1200px;
            height: 630px;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            padding: 44px 52px;
            gap: 26px;
        }

        .top {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, #4f46e5, #06b6d4);
        }

        .title {
            font-size: 34px;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .badge {
            font-size: 14px;
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 999px;
            color: rgba(255, 255, 255, 0.86);
            background: rgba(255, 255, 255, 0.06);
        }

        .grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
        }

        .card {
            border-radius: 22px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.06);
            overflow: hidden;
            position: relative;
        }

        .label {
            position: absolute;
            top: 14px;
            left: 14px;
            font-size: 13px;
            font-weight: 700;
            padding: 7px 10px;
            border-radius: 999px;
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(6px);
        }

        .mapimg {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .desc {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.82);
        }

        .small {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.72);
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
    </style>
</head>

<body>
    <div class="frame">
        <div class="top">
            <div class="brand">
                <div class="logo"></div>
                <div class="title">Sync View</div>
            </div>
            <div class="badge" id="badge">Shared map state</div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="label" id="label1">Map 1</div>
                <img class="mapimg" id="img1" alt="Map 1 preview" />
            </div>
            <div class="card">
                <div class="label" id="label2">Map 2</div>
                <img class="mapimg" id="img2" alt="Map 2 preview" />
            </div>
        </div>

        <div class="bottom">
            <div class="desc" id="desc">Compare two locations side by side.</div>
            <div class="small mono" id="meta"></div>
        </div>
    </div>

    <script>
        function b64UrlDecodeBytes(b64u) {
            const b64 = String(b64u).replace(/-/g, '+').replace(/_/g, '/');
            const padded = b64 + '='.repeat((4 - (b64.length % 4)) % 4);
            const bin = atob(padded);
            const bytes = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
            return bytes;
        }

        function clamp(n, min, max) {
            const x = Number(n);
            if (!Number.isFinite(x)) return min;
            return Math.min(max, Math.max(min, x));
        }

        function decodeMapType(code) {
            if (code === 1) return 'streets';
            if (code === 2) return 'satellite';
            return 'hybrid';
        }

        function decodeAppState(encoded) {
            const raw = String(encoded || '');
            if (!raw) return null;
            try {
                const bytes = b64UrlDecodeBytes(raw);
                const dv = new DataView(bytes.buffer, bytes.byteOffset, bytes.byteLength);
                let o = 0;

                if (dv.byteLength < 24) return null;
                const v = dv.getUint8(o); o += 1;
                if (v !== 1) return null;

                const z = dv.getUint16(o, true) / 100; o += 2;
                const m1lat = dv.getInt32(o, true) / 1e6; o += 4;
                const m1lng = dv.getInt32(o, true) / 1e6; o += 4;
                const m2lat = dv.getInt32(o, true) / 1e6; o += 4;
                const m2lng = dv.getInt32(o, true) / 1e6; o += 4;
                const modeCode = dv.getUint8(o); o += 1;
                o += 1; // ref
                const mapTypeCode = dv.getUint8(o); o += 1;
                const ptsCount = dv.getUint16(o, true); o += 2;

                if (dv.byteLength !== 24 + ptsCount * 8) return null;

                return {
                    z,
                    m1: [clamp(m1lat, -85.05112878, 85.05112878), clamp(m1lng, -180, 180)],
                    m2: [clamp(m2lat, -85.05112878, 85.05112878), clamp(m2lng, -180, 180)],
                    mode: modeCode === 1 ? 'area' : 'dist',
                    mapType: decodeMapType(mapTypeCode)
                };
            } catch (_) {
                return null;
            }
        }

        function tileXY(lat, lng, zoom) {
            const z = clamp(Math.round(zoom), 0, 20);
            const latClamped = clamp(lat, -85.05112878, 85.05112878);
            const lngClamped = clamp(lng, -180, 180);
            const latRad = latClamped * Math.PI / 180;
            const n = Math.pow(2, z);
            const x = Math.floor((lngClamped + 180) / 360 * n);
            const y = Math.floor((1 - Math.log(Math.tan(latRad) + 1 / Math.cos(latRad)) / Math.PI) / 2 * n);
            return { x, y, z };
        }

        function osmTileUrl(lat, lng, zoom) {
            const t = tileXY(lat, lng, zoom);
            return 'https://tile.openstreetmap.org/' + t.z + '/' + t.x + '/' + t.y + '.png';
        }

        function arcGisTileUrl(lat, lng, zoom) {
            const t = tileXY(lat, lng, zoom);
            return 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/' + t.z + '/' + t.y + '/' + t.x;
        }

        (function () {
            const url = new URL(window.location.href);
            const s = url.searchParams.get('s');
            const v = url.searchParams.get('v') || '';

            const state = decodeAppState(s);
            const badge = document.getElementById('badge');
            const meta = document.getElementById('meta');
            const desc = document.getElementById('desc');

            if (!state) {
                if (badge) badge.textContent = 'Default preview';
                if (desc) desc.textContent = 'Open Sync View to compare two locations side by side.';
                if (meta) meta.textContent = '';
                return;
            }

            const mapType = state.mapType || 'hybrid';
            const z = clamp(state.z, 0, 20);
            const m1 = state.m1;
            const m2 = state.m2;

            if (badge) badge.textContent = 'Shared state · ' + mapType;
            if (meta) meta.textContent = 'z=' + z + (v ? (' · v=' + v) : '');
            if (desc) desc.textContent = 'Map 1: ' + m1[0].toFixed(4) + ',' + m1[1].toFixed(4) + '  |  Map 2: ' + m2[0].toFixed(4) + ',' + m2[1].toFixed(4);

            const img1 = document.getElementById('img1');
            const img2 = document.getElementById('img2');

            const tileUrl = (mapType === 'streets') ? osmTileUrl : arcGisTileUrl;

            if (img1) img1.src = tileUrl(m1[0], m1[1], z);
            if (img2) img2.src = tileUrl(m2[0], m2[1], z);
        })();
    </script>
</body>

</html>
